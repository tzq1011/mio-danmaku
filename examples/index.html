<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  <style>
    #container { background-color: #000; }
    #video { position: absolute; }
    #comments { position: absolute; pointer-events: none; }
  </style>
  <div id="container">
    <video id="video" controls webkit-playsinline></video>
    <div id="comments"></div>
  </div>
  <script src="mio-danmaku.js"></script>
  <script>
    const {
      createStackingComment,
      createScrollingComment,
      createPositioningComment,
      createPlayer,
    } = mioDanmaku;

    const containerElement = document.getElementById("container");
    const videoElement = document.getElementById("video");
    const commentsElement = document.getElementById("comments");
  
    function timeGetter() {
      return videoElement.currentTime * 1000;
    }

    const danmakuPlayer = createPlayer({ timeGetter });
    commentsElement.appendChild(danmakuPlayer.element);
    danmakuPlayer.renderer.screenMarginBottom = 40;

    videoElement.addEventListener("playing", () => {
        if (danmakuPlayer.state !== "playing") {
          danmakuPlayer.play();
        }
      });

    videoElement.addEventListener("pause", () => {
        if (danmakuPlayer.state !== "paused") {
          danmakuPlayer.pause();
        }
      });

    const videoUrl = "https://images.apple.com/media/cn/macbook-pro/2016/b4a9efaa_6fe5_4075_a9d0_8e4592d6146c/films/design/macbook-pro-design-tft-cn-20161026_1536x640h.mp4";
    // const videoUrl = "video.mp4";
    videoElement.src = videoUrl;
    videoElement.play();

    function resize(width, height) {
      containerElement.style.width = width + "px";
      containerElement.style.height = height + "px";
      videoElement.style.width = width + "px";
      videoElement.style.height = height + "px";
      commentsElement.style.width = width + "px";
      commentsElement.style.height = height + "px";
      danmakuPlayer.resize(width, height);
    }

    resize(846, 568);

    const xhr = new XMLHttpRequest();
    xhr.onload = () => {
      const dList = xhr.responseXML.querySelectorAll("d");
      const comments = [];

      dList.forEach((d) => {
        const p = d.getAttribute("p");
        const pItems = p.split(",");
        const text = d.childNodes[0].nodeValue;
        const time = Math.round(pItems[0] * 1000);
        const type = pItems[1];
        const fontSize = pItems[2];
        const fontColor = "#" + Number(pItems[3]).toString(16).padStart(6, "0");

        const commonOptions = {
          time,
          text,
          fontSize,
          fontColor,
        };

        let comment;

        if (type === "1") {
          const options = Object.assign(
            {},
            commonOptions,
            { scrollingDirection: "left" }
          );

          comment = createScrollingComment(options);
        } else if (type === "4") {
          const options = Object.assign(
            {},
            commonOptions,
            { stackingDirection: "up" }
          );

          comment = createStackingComment(options);
        } else if (type === "5") {
          const options = Object.assign(
            {},
            commonOptions,
            { stackingDirection: "down" }
          );

          comment = createStackingComment(options);
        }

        if (comment != null) {
          comments.push(comment);
        }
      });

      danmakuPlayer.commentPool.load(comments);
    };

    xhr.open("GET", "bilibili.xml");
    xhr.responseType = "document";
    xhr.send();

    // danmakuPlayer.commentPool.add(createStackingComment({ time: 3000 }));
  </script>
</body>
</html>