<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  <div id="danmaku-player" style="background-color: #333; width: 846px; height: 566px;"></div>
  <script src="mio-danmaku.js"></script>
  <script>
    const {
      createStage,
      createScrollingComment,
      createStackingComment,
      createPlayer,
    } = mioDanmaku;

    const container = document.getElementById("danmaku-player");

    let elapsedTimeWhenPaused = 0;
    let timeWhenPlaying;

    function timeGetter() {
      let elapsedTime = elapsedTimeWhenPaused;

      if (timeWhenPlaying != null) {
        elapsedTime += Date.now() - timeWhenPlaying;
      }

      return elapsedTime;
    }

    function play() {
      timeWhenPlaying = Date.now();
      player.play();
    }

    function pause() {
      elapsedTimeWhenPaused = timeGetter();
      timeWhenPlaying = undefined;
      player.pause();
    }

    const stage = createStage({ width: 846, height: 566 });
    const player = createPlayer({ stage, timeGetter });
    container.appendChild(player.element);

    const xhr = new XMLHttpRequest();
    xhr.onload = () => {
      const dList = xhr.responseXML.querySelectorAll("d");
      const comments = [];

      dList.forEach((d) => {
        const p = d.getAttribute("p");
        const pItems = p.split(",");
        const text = d.childNodes[0].nodeValue;
        const time = Math.round(pItems[0] * 1000);
        const type = pItems[1];
        const fontSize = pItems[2];
        const fontColor = "#" + Number(pItems[3]).toString(16).padStart(6, "0");

        const commonOptions = {
          time,
          text,
          fontSize,
          fontColor,
        };

        let comment;

        if (type === "1") {
          comment = createScrollingComment(commonOptions);
        } else if (type === "4") {
          const options = Object.assign(
            {},
            commonOptions,
            { stackingDirection: "up" }
          );

          comment = createStackingComment(options);
        } else if (type === "5") {
          const options = Object.assign(
            {},
            commonOptions,
            { stackingDirection: "down" }
          );

          comment = createStackingComment(options);
        }

        if (comment != null) {
          comments.push(comment);
        }
      });

      player.commentPool.load(comments);
      play();
    };

    xhr.open("GET", "bilibili.xml");
    xhr.responseType = "document";
    xhr.send();

    // player.play();
    // player.renderer.renderComment(mioDanmaku.createScrollingComment({ text: "笑死了", isOwn: true }));
    // setTimeout(() => {
    //   player.renderer.renderComment(mioDanmaku.createScrollingComment({ text: "笑死了333", isOwn: true }));
    // }, 1000);

  </script>
</body>
</html>